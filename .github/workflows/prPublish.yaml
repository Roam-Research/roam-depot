name: Publish Extension Pull Request

# Privileged workflow - has write permissions and secrets access
# Triggered after the unprivileged build workflow completes
on:
  workflow_run:
    workflows: ["Build Extension Pull Request"]
    types:
      - completed

jobs:
  publish:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - run: |
          echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
          echo "$JAVA_HOME_17_X64/bin" >> $GITHUB_PATH

      - run: |
          curl -sLO https://download.clojure.org/install/linux-install-1.11.1.1113.sh
          chmod +x linux-install-1.11.1.1113.sh
          sudo ./linux-install-1.11.1.1113.sh

      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      # Download build artifacts from the unprivileged workflow
      - name: Download checkout artifact
        uses: actions/download-artifact@v6
        with:
          name: checkout
          path: checkout
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Download PR info artifact
        uses: actions/download-artifact@v6
        with:
          name: pr-info
          path: pr-info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      # Remove any symlinks from artifacts to prevent symlink attacks
      - name: Remove symlinks from artifacts
        run: |
          find checkout -type l -print -delete
          find pr-info -type l -print -delete

      - name: Read PR number
        id: pr-number
        run: echo "PR_NUMBER=$(cat pr-info/PR_NUMBER)" >> $GITHUB_OUTPUT

      - run: clojure -P -M:firebase
        name: Fetch deps

      - run: echo $FIREBASE_SERVICE_KEY > ./firebase-key.json
        env:
          FIREBASE_SERVICE_KEY: ${{ secrets.FIREBASE_SERVICE_KEY }}

      - name: Publish PR extension
        id: publish
        run: ./script/publish.sh --pr ${{ steps.pr-number.outputs.PR_NUMBER }} --key ./firebase-key.json

      - name: Cleanup credentials
        if: always()
        run: rm -f ./firebase-key.json

      # Add comment to PR with diff links and publish status
      - name: Comment on PR
        if: always()
        env:
          PR: ${{ steps.pr-number.outputs.PR_NUMBER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_STATUS: ${{ steps.publish.outcome }}
        run: |
          ./script/comment.sh --pr $PR --token $GITHUB_TOKEN --status $PUBLISH_STATUS

